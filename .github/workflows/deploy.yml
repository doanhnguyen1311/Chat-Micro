name: Deploy Chat Application

on:
  push:
    branches:
      - delichatFE # ฤแบฃm bแบฃo ฤรขy lร nhรกnh bแบกn muแปn triแปn khai

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy via SSH
        # Sแปญ dแปฅng phiรชn bแบฃn cแปฅ thแป thay vรฌ @master ฤแป ฤแบฃm bแบฃo แปn ฤแปnh
        uses: appleboy/ssh-action@v1.0.0 
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_KEY }}
          port: 22

          script: |
            # Dรฒng nรy RแบคT QUAN TRแปNG: Script sแบฝ dแปซng ngay lแบญp tแปฉc nแบฟu cรณ bแบฅt kแปณ lแปnh nรo bรกo lแปi
            set -e

            # 1. KHแปI TแบO MรI TRฦฏแปNG NODE.JS
            # ฤรขy lร cรกch chuแบฉn ฤแป load NVM trong mแปt script khรดng tฦฐฦกng tรกc
            export NVM_DIR="$HOME/.nvm"
            [ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"
            echo "ฤรฃ khแปi tแบกo NVM."
            
            # Sแปญ dแปฅng phiรชn bแบฃn Node.js mแบทc ฤแปnh ฤรฃ cรi (nแบฟu bแบกn ฤรฃ dรนng `nvm alias default ...`)
            nvm use default
            echo "Sแปญ dแปฅng Node.js phiรชn bแบฃn: $(node -v)"
            echo "Sแปญ dแปฅng npm phiรชn bแบฃn: $(npm -v)"

            # 2. CแบฌP NHแบฌT CODE Tแปช REPOSITORY
            cd ~/Chat-Micro
            echo "ฤang แป trong thฦฐ mแปฅc $(pwd)"
            
            # Cรกch cแบญp nhแบญt code an toรn hฦกn:
            # - git fetch: Lแบฅy thรดng tin mแปi nhแบฅt tแปซ remote nhฦฐng chฦฐa รกp dแปฅng.
            # - git reset --hard: Buแปc HEAD cแปงa nhรกnh cแปฅc bแป phแบฃi trรนng khแปp vแปi HEAD cแปงa nhรกnh trรชn remote.
            # Cรกch nรy sแบฝ xรณa mแปi thay ฤแปi chฦฐa commit trรชn server, ฤแบฃm bแบฃo code sแบกch sแบฝ.
            git fetch origin delichatFE
            git reset --hard origin/delichatFE
            echo "ฤรฃ cแบญp nhแบญt code tแปซ nhรกnh delichatFE thรnh cรดng."

            # 3. DแปชNG CรC TIแบพN TRรNH Cลจ
            echo "ฤang tรฌm vร dแปซng cรกc tiแบฟn trรฌnh cลฉ trรชn cแปng 5173 vร 5174..."
            # Dรนng `fuser` hoแบทc `lsof`. `|| true` ฤแป script khรดng bแป lแปi nแบฟu khรดng tรฌm thแบฅy tiแบฟn trรฌnh nรo.
            sudo fuser -k 5173/tcp || true
            sudo fuser -k 5174/tcp || true
            echo "ฤรฃ dแปซng cรกc tiแบฟn trรฌnh cลฉ (nแบฟu cรณ)."
            
            # --- TRIแปN KHAI VITE-PROJECT ---
            echo "================================="
            echo "Bแบฏt ฤแบงu triแปn khai vite-project"
            echo "================================="
            cd vite-project
            
            echo "ฤang cรi ฤแบทt dependencies bแบฑng 'npm ci' (nhanh vร an toรn hฦกn)..."
            # npm ci sแบฝ xรณa node_modules vร cรi ฤแบทt sแบกch tแปซ package-lock.json
            npm ci
            
            echo "Khแปi chแบกy vite-project trรชn cแปng 5173 trong nแปn..."
            # Chแบกy trong nแปn, lฦฐu log vร ngแบฏt kแบฟt nแปi vแปi phiรชn SSH
            nohup npx vite --host 0.0.0.0 --port 5173 > vite.log 2>&1 &
            disown
            cd .. # Quay lแบกi thฦฐ mแปฅc ~/Chat-Micro
            echo "โ vite-project ฤรฃ ฤฦฐแปฃc khแปi chแบกy."
            
            # ฤแปฃi mแปt chรบt ฤแป server khรดng bแป quรก tแบฃi
            sleep 5 

            # --- TRIแปN KHAI SOCIAL-PROJECT ---
            echo "=================================="
            echo "Bแบฏt ฤแบงu triแปn khai social-project"
            echo "=================================="
            cd social-project
            
            echo "ฤang cรi ฤแบทt dependencies bแบฑng 'npm ci'..."
            npm ci
            
            echo "Khแปi chแบกy social-project trรชn cแปng 5174 trong nแปn..."
            nohup npx vite --host 0.0.0.0 --port 5174 > social.log 2>&1 &
            disown
            cd ..
            echo "โ social-project ฤรฃ ฤฦฐแปฃc khแปi chแบกy."

            echo "๐๐๐ Quรก trรฌnh triแปn khai hoรn tแบฅt! ๐๐๐"
