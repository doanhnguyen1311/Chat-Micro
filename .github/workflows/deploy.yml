name: Deploy Backend Account Service

on:
  push:
    branches:
      - service/account-service # Cháº¡y workflow khi cÃ³ push lÃªn nhÃ¡nh nÃ y

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy Backend via SSH
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.DAWS_VPS_HOST }}
          username: ${{ secrets.DAWS_VPS_USER }}
          key: ${{ secrets.DAWS_VPS_KEY }}
          port: 22

          script: |
            # Dá»«ng script láº­p tá»©c náº¿u lá»—i
            set -e

            # 1. Cáº¬P NHáº¬T CODE Tá»ª REPOSITORY
            # Thay Ä‘á»•i '~/Chat-Micro' náº¿u thÆ° má»¥c dá»± Ã¡n cá»§a báº¡n cÃ³ tÃªn khÃ¡c trÃªn server
            cd ~/Chat-Micro 
            echo "Äang á»Ÿ trong thÆ° má»¥c $(pwd)"
            
            # Láº¥y code má»›i nháº¥t tá»« nhÃ¡nh service/account-service
            git fetch origin service/account-service
            git reset --hard origin/service/account-service
            echo "ÄÃ£ cáº­p nháº­t code tá»« nhÃ¡nh service/account-service thÃ nh cÃ´ng."

            # 2. Dá»ªNG TIáº¾N TRÃŒNH CÅ¨
            echo "Äang tÃ¬m vÃ  dá»«ng tiáº¿n trÃ¬nh cÅ© trÃªn cá»•ng 8080..."
            # Sá»­ dá»¥ng fuser Ä‘á»ƒ kill tiáº¿n trÃ¬nh Ä‘ang chiáº¿m cá»•ng 8080. 
            # '|| true' Ä‘á»ƒ script khÃ´ng bá»‹ lá»—i náº¿u khÃ´ng tÃ¬m tháº¥y tiáº¿n trÃ¬nh nÃ o.
            sudo fuser -k 8080/tcp || true
            echo "ÄÃ£ dá»«ng tiáº¿n trÃ¬nh cÅ© trÃªn cá»•ng 8080 (náº¿u cÃ³)."
            
            # 3. KHá»I CHáº Y á»¨NG Dá»¤NG BACKEND
            echo "=========================================="
            echo "Báº¯t Ä‘áº§u triá»ƒn khai account-service"
            echo "=========================================="
            
            echo "Khá»Ÿi cháº¡y á»©ng dá»¥ng Spring Boot báº±ng 'mvn spring-boot:run'..."
            # Cháº¡y trong ná»n, lÆ°u log vÃ o file account-service.log
            # vÃ  ngáº¯t káº¿t ná»‘i vá»›i phiÃªn SSH Ä‘á»ƒ tiáº¿n trÃ¬nh tiáº¿p tá»¥c cháº¡y.
            nohup mvn spring-boot:run > account-service.log 2>&1 &
            
            echo "âœ… Backend account-service Ä‘Ã£ Ä‘Æ°á»£c khá»Ÿi cháº¡y trÃªn cá»•ng 8080."
            echo "ğŸš€ğŸš€ğŸš€ QuÃ¡ trÃ¬nh triá»ƒn khai backend hoÃ n táº¥t! ğŸš€ğŸš€ğŸš€"